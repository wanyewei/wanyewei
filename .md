---
marp: true
theme: default
paginate: true
css: custom.css
---

# Beyond XSS:探索前端資安宇宙 ch5-1~5-6

## ClickJacking、MIME sniffing、前端供應鏈攻擊、前端攻擊在 Web3 的應用、XS-Leaks、XS-Leaks 的進階應用

                                     Speaker : Wanye

                                     Note Taker :

                                     2025/01/23 @Tech-Book-Community

---

# Hi! I'm Wanye

- 剛滿一年的前端工程師
- 興趣 : 聽音樂、有時候會看劇、看漫畫

---

# 前次回顧

---

# <h1>5-1 你的畫面不是你的畫面:ClickJacking 點擊劫持<h1/>

ClickJacking，中文又稱點擊劫持。
指的是你以為點擊的是 A 網站的內容，但實際上你的點擊被「劫持」到 B 網站。
例如，若背後是一個銀行轉帳頁面，帳號與金額都已填好，只需點一下按鈕就會完成轉帳，這可能造成嚴重後果。（這只是舉例而已，不過從這個案例就能知道為什麼轉帳需要第二層驗證了）。

---

# ClickJacking 攻擊原理

### 什麼是 ClickJacking?

把兩個網頁疊在一起，透過 CSS 讓使用者看見的是 A 網頁，但點到的卻是 B 網頁。

### 手法:

用 ifram 將 B 網頁崁入然後設定透明度 0.001，再用 css 打自己的內容疊上去。

### 問題 :

表面按鈕顯示「確定取消」，實際點擊觸發「刪除帳號」。

![bg contain right:40% ](https://aszx87410.github.io/beyond-xss/assets/images/27-01-f8b29f27dad8860c275ded5c27f19c5d.gif)

---

# 攻擊範例:

- 以 「更改 email」功能設計的 clickjacking 攻擊，留下原網頁的 input，其他都用 CSS 蓋掉，按鈕的部分用 pointer-events:none 讓事件穿透。
- 表面上看起來是一個輸入 email 訂閱資訊的頁面，但實際背後運作的是「修改 email」的功能。
  ![bg contain right:40% ](https://aszx87410.github.io/beyond-xss/assets/images/27-02-b6abe4eb1873c50a6527e1b6f48230f1.gif)

---

# 點擊劫持的攻擊流程

1. 把目標網頁嵌入惡意網頁之中（透過 iframe 或其他類似標籤）
2. 在惡意網頁上用 CSS 把目標網頁蓋住，讓使用者看不見
3. 誘導使用者前往惡意網頁並且做出操作（輸入或點擊等等）
4. 觸發目標網頁行為，達成攻擊

小結 : clickjacking 的實現取決於攻擊者的設計巧妙程度與目標網站的交互複雜性。防範此類攻擊需要網站和使用者的共同努力，然而這種攻擊需要達成，<span style="background:#efefef">使用者一定需要在目標網站是登入狀態</span>。

---

# Clickjacking 的防禦方式

- 自己用 JavaScript 檢查
- 透過 response header 告知瀏覽器這個網頁是否能被嵌入。

---

# Frame busting(自己用 JavaScript 檢查)

```
if (top !== self) {
  top.location = self.location
}
```

- 每個網頁都有自己的 window，self 總是指向當前網頁的 window。

- 如果網頁被獨立開啟，top 和 self 會指向相同的 window。
- 如果網頁嵌套於 iframe 中，top 會指向外層（最上層）的 window。

---

# iframe 的 sandbox 屬性

- 功用 : 限制 iframe 的行為，避免惡意嵌套攻擊
- 常用限制:
  - allow-forms，允許提交表單
  - allow-scripts，允許執行 JS
  - allow-top-navigation，允許改變 top location
  - allow-popups，允許彈出視窗

---

# 範例一 :

<img src="https://aszx87410.github.io/beyond-xss/assets/images/27-03-7dc26cf7765c47dfc96d4ebbd85d8527.png" height="80%" />

---

- 情境 : 在 localhost 的 index.html 裡面寫了:

```
<iframe src="https://example.com"></iframe>
<iframe src="https://huli.tw"></iframe>
```

- iframe 中的兩個網頁 (綠色、黃色)

  - 兩個不同的 window
  - 存取 top 時，指向主頁 localhost/index.html 的 window

- 檢查 -透過 if (top !== self) 判斷是否在 iframe 中，是的話則改變 top.location ，將最上層導向其他網站。

- 這邊要注意的是會被 iframe 的 sandbox 屬性繞過。這個屬性之前在「就算只有 HTML 也能攻擊？」那篇有提過了。

---

# 繞過方式

```
<iframe src="./busting.html" sandbox="allow-forms">
```

- 防護失敗: busting.html 做了 top==self 的檢查也沒用。
- 原因 : 沒有 allow-script 無法執行 JS ，但表單可正常送出。
- 接下來就要介紹其他人在現有基礎上改良也更實用的方式。

---

# 改良後的方式(程式碼取自：[Wikipedia - Framekiller](https://en.wikipedia.org/wiki/Framekiller))

```<style>html{display:none;}</style>
<script>
   if (self == top) {
       document.documentElement.style.display = 'block';
   } else {
       top.location = self.location;
   }
</script>
```

- 功用: 一定需要執行 JS 或通過 JS 檢查才會開啟，否則網頁會整個隱藏。

- 缺點: 如果使用者主動關閉瀏覽器的 JavaScript 功能，網頁也無法顯示，導致不好的用戶體驗。

- 在 2008 年 clickjacking 剛出來的時候，相關防禦方式還沒有這麼完整，所以只好用這些比較像是 workaround 的解法。而現在，瀏覽器已經支援了其他更好的方式來阻擋網頁被嵌入。

---

# X-Frame-Options
